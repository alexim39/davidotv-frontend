<div class="mobile-video-container" #videoContainer>

  <mat-progress-bar mode="indeterminate" *ngIf="isLoading()" @fadeInOut/>


  <div class="video-wrapper">
    <iframe
      #videoFrame
      [src]="safeUrl"
      width="100%"
      height="100%"
      frameborder="0"
      allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
    ></iframe>

   <!--  <div class="loading-overlay" *ngIf="isLoading()" @fadeInOut>
      <mat-spinner diameter="40"></mat-spinner>
      <span class="loading-text">Loading...</span>
    </div> -->

   <!--  <div class="unmute-hint" *ngIf="isPlaying() && isMuted()" (click)="toggleMute()">
      <mat-icon>volume_off</mat-icon>
      <span class="unmute-text">Tap to unmute</span>
    </div> -->

    <div class="controls-overlay" 
        *ngIf="showControls()" 
        @fadeInOut
        (click)="$event.stopPropagation()">
      
      <div class="top-controls">
        <button mat-icon-button 
                class="control-button mute-button"
                (click)="toggleMute()"
                [attr.aria-label]="isMuted() ? 'Unmute' : 'Mute'">
          <mat-icon>{{ isMuted() ? 'volume_off' : 'volume_up' }}</mat-icon>
        </button>
        
       <!--  <div class="video-progress-mini">
          <div class="progress-bar-mini" [style.width.%]="progressPercentage()"></div>
        </div> -->
      </div>

      <div class="side-controls">
        <div class="creator-avatar" (click)="openCreatorProfile()">
          <img [src]="currentVideo.channelThumbnail || user?.avatar || '/img/ytch.jpeg'" 
               alt="Creator" 
               class="avatar-image">
          <div class="follow-button" *ngIf="!isFollowing">
            <mat-icon>add</mat-icon>
          </div>
        </div>

        <div class="action-button like-button" 
              (click)="handleLikeAction()"
              [@heartBeat]="liked() ? 'liked' : 'unliked'">
          <div class="action-icon-wrapper">
            <mat-icon class="action-icon" 
                      [class.liked]="liked()">
              {{ liked() ? 'favorite' : 'favorite_border' }}
            </mat-icon>
          </div>
          <span class="action-count">{{ formattedLikes() }}</span>
        </div>

        <div class="action-button" (click)="openComments()">
          <div class="action-icon-wrapper">
            <mat-icon class="action-icon">comment</mat-icon>
          </div>
          <span class="action-count">{{ formattedComments() }}</span>
        </div>

        <div class="action-button" (click)="shareVideo()">
          <div class="action-icon-wrapper">
            <mat-icon class="action-icon">share</mat-icon>
          </div>
          <span class="action-text">Share</span>
        </div>

        <div class="action-button" (click)="saveVideo()">
          <div class="action-icon-wrapper">
            <mat-icon class="action-icon" 
                      [class.saved]="saved()">
              {{ saved() ? 'bookmark' : 'bookmark_border' }}
            </mat-icon>
          </div>
          <span class="action-text">{{ saved() ? 'Saved' : 'Save' }}</span>
        </div>

        <div class="action-button" (click)="openVideoInfo()">
          <div class="action-icon-wrapper">
            <mat-icon class="action-icon">more_horiz</mat-icon>
          </div>
        </div>
      </div>

      <div class="bottom-controls">
        <div class="video-info" (click)="openVideoInfo()">
          <div class="creator-info">
            <span class="creator-name">{{ currentVideo.channel }}</span>
            <mat-icon class="verified-icon" *ngIf="currentVideo?.verified">verified</mat-icon>
          </div>
          <div class="video-title" [title]="currentVideo.title">
            {{ currentVideo.title }}
          </div>
          <div class="video-description" 
               *ngIf="currentVideo?.description"
               [class.expanded]="showFullDescription()">
            {{ showFullDescription() ? currentVideo.description : (currentVideo.description | slice:0:100) }}
            <span class="expand-toggle" 
                  *ngIf="currentVideo.description && currentVideo.description.length > 100"
                  (click)="toggleDescription($event)">
              {{ showFullDescription() ? ' Show less' : '... Show more' }}
            </span>
          </div>

          <div class="video-tags" *ngIf="currentVideo?.tags?.length">
            <span class="tag" *ngFor="let tag of currentVideo.tags | slice:0:3">
              #{{ tag }}
            </span>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar" [style.width.%]="progressPercentage()"></div>
        </div>
        
        <div class="time-display">
          <span>{{ formattedCurrentTime() }}</span>
          <span class="separator">/</span>
          <span>{{ formattedDuration() }}</span>
        </div>
      </div>
    </div>

    <!-- <div class="center-controls" *ngIf="showControls() || !isPlaying()" @scaleAnimation>
      <button mat-icon-button 
              class="play-button"
              (click)="togglePlayPause()"
              [attr.aria-label]="isPlaying() ? 'Pause' : 'Play'">
        <mat-icon>{{ isPlaying() ? 'pause' : 'play_arrow' }}</mat-icon>
      </button>
    </div> -->

  </div>

  <div class="like-animation-area left-area" (dblclick)="seekRelative(-10)">
    <div class="seek-indicator">
      <mat-icon>fast_rewind</mat-icon>
      <span>10s</span>
    </div>
  </div>
  
  <div class="like-animation-area right-area" (dblclick)="seekRelative(10)">
    <div class="seek-indicator">
      <mat-icon>fast_forward</mat-icon>
      <span>10s</span>
    </div>
  </div>

  @if (showControls()) {
    <div class="navigation-hints" @fadeInOut>
      <button class="navigation-hint hint-up" (click)="playPreviousVideo()">
        <div class="arrow-icon">▲</div>
        <!-- <span>Previous video</span> -->
      </button>
      <button class="navigation-hint hint-down" (click)="playNextVideo()">
        <div class="arrow-icon">▼</div>
        <!-- <span>Next video</span> -->
      </button>
    </div>
  }

  </div>